<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEDUS | Pro Analytics Dashboard 2026</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --fedus-orange: #f39c12; 
            --fedus-dark-orange: #d35400;
            --bg-blue: #f4f7f9; 
            --accent-blue: #2980b9;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --white: #ffffff;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
            --header-grad: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            --green: #27ae60;
            --red: #e74c3c;
        }
        
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background-color: var(--bg-blue); 
            margin: 0; color: var(--text-main); 
            line-height: 1.6;
        }

        /* --- Layout --- */
        .header { 
            background: var(--header-grad); 
            padding: 1rem 3rem; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header img { height: 45px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .header h1 { color: white; margin: 0; font-size: 1.5rem; letter-spacing: 2px; text-transform: uppercase; }

        .wrapper { padding: 2rem; max-width: 1600px; margin: 0 auto; }

        /* --- Toolbar --- */
        .toolbar {
            display: grid; grid-template-columns: 2fr 1fr auto; gap: 1.5rem;
            background: var(--white); padding: 1.5rem; border-radius: 16px;
            box-shadow: var(--card-shadow); margin-bottom: 2rem;
            align-items: end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-group label { font-size: 0.75rem; font-weight: 700; color: var(--accent-blue); text-transform: uppercase; }
        .filter-group input { 
            padding: 0.8rem 1rem; border: 1.5px solid #e1e8ed; border-radius: 8px;
            font-size: 0.9rem; transition: all 0.3s ease;
        }
        .filter-group input:focus { border-color: var(--fedus-orange); outline: none; box-shadow: 0 0 0 3px rgba(243,156,18,0.1); }

        .btn-actions { display: flex; gap: 0.75rem; }
        .btn {
            padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 700;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #1f6391; transform: translateY(-2px); }
        .btn-outline { background: #f8f9fa; border: 1.5px solid #e1e8ed; color: var(--text-muted); }
        .btn-outline:hover { background: #eee; }

        /* --- Metrics --- */
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .card { 
            background: var(--white); padding: 1.5rem; border-radius: 16px; 
            box-shadow: var(--card-shadow); position: relative; overflow: hidden;
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: var(--fedus-orange); }
        .card.alt::before { background: var(--accent-blue); }

        .card h2 { margin: 0; font-size: 2.5rem; color: var(--accent-blue); }
        .card p { margin: 0.5rem 0 0; font-weight: 700; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }
        
        .momentum { font-size: 0.85rem; font-weight: 800; margin-top: 0.75rem; display: flex; align-items: center; gap: 5px; }
        .up { color: var(--green); }
        .down { color: var(--red); }

        /* --- Visualizations --- */
        .viz-section { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .chart-container { background: white; padding: 1.5rem; border-radius: 16px; box-shadow: var(--card-shadow); height: 350px; }
        
        .stats-list { list-style: none; padding: 0; margin: 0; }
        .stats-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0;
        }
        .stats-row:last-child { border: none; }
        .stats-name { font-size: 0.85rem; font-weight: 600; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .stats-val { background: var(--bg-blue); padding: 2px 10px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; }

        /* --- Table --- */
        .table-card { background: white; border-radius: 16px; box-shadow: var(--card-shadow); overflow: hidden; }
        .table-header { padding: 1.5rem; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .table-header h3 { margin: 0; font-size: 1.1rem; }

        .table-wrap { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { 
            background: #fafbfc; position: sticky; top: 0; z-index: 10;
            padding: 1.2rem 1rem; text-align: left; font-size: 0.7rem; 
            text-transform: uppercase; letter-spacing: 1px; color: var(--accent-blue);
            border-bottom: 2px solid #edf2f7;
        }
        td { padding: 1rem; border-bottom: 1px solid #f4f7f9; font-size: 0.85rem; white-space: nowrap; }
        tr:hover { background-color: #fcfdfe; }
        
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .badge-amazon { background: #fff3e0; color: #ef6c00; }
        .badge-blinkit { background: #e8f5e9; color: #2e7d32; }

        #loading {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--fedus-orange); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--fedus-orange); }
    </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p style="margin-top:1rem; font-weight:700;">SYNCING DATABASE...</p></div>

<header class="header">
    <img src="https://raw.githubusercontent.com/sachinfedus-lang/2026-data/main/logo.png" alt="FEDUS">
    <h1>Exclusive Dashboard</h1>
</header>

<main class="wrapper">
    <section class="toolbar">
        <div class="filter-group">
            <label><i class="fa fa-search"></i> Universal Search</label>
            <input type="text" id="search" placeholder="Search orders, customers, product codes..." onkeyup="handleFilter()">
        </div>
        <div class="filter-group">
            <label><i class="fa fa-calendar"></i> Date Range</label>
            <input type="text" id="dateRange" placeholder="Select Dates">
        </div>
        <div class="btn-actions">
            <button class="btn btn-primary" onclick="init()"><i class="fa fa-sync"></i> Refresh</button>
            <button class="btn btn-outline" onclick="resetFilters()">Reset</button>
        </div>
    </section>

    <section class="metrics-grid">
        <div class="card">
            <h2 id="m-total">0</h2>
            <p>Total Orders</p>
            <div id="m-momentum" class="momentum"></div>
        </div>
        <div class="card alt">
            <h2 id="m-amazon">0</h2>
            <p>Amazon Orders</p>
            <div id="m-amazon-growth" class="momentum"></div>
        </div>
        <div class="card alt">
            <h2 id="m-blinkit">0</h2>
            <p>Blinkit Orders</p>
            <div id="m-blinkit-growth" class="momentum"></div>
        </div>
        <div class="card">
            <h2 id="m-unique">0</h2>
            <p>Unique Customers</p>
        </div>
    </section>

    <section class="viz-section">
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
        <div class="card">
            <p style="margin-bottom:1rem; color:var(--accent-blue);">Top 5 Products</p>
            <div id="top-products" class="stats-list"></div>
        </div>
    </section>

    <section class="table-card">
        <div class="table-header">
            <h3 id="table-count">Order Logs</h3>
            <div class="stats-val" id="filter-indicator">Showing All Records</div>
        </div>
        <div class="table-wrap">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width: 100px;">Date</th>
                        <th style="width: 250px;">Product Name</th>
                        <th style="width: 150px;">Customer</th>
                        <th style="width: 150px;">Order ID</th>
                        <th style="width: 100px;">Platform</th>
                        <th style="width: 120px;">State</th>
                        <th style="width: 140px;">Product Code</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </section>
</main>

<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTo_H6uUDOXjAILtefs-VU0oG-OxyLGMkxxBTgvkVjL-xtkOXKDpzewRtLQxTYg-2HfNoO6C3TuQa-H/pub?gid=1747140024&single=true&output=csv';
    
    let db = [];
    let trendChart = null;
    const fp = flatpickr("#dateRange", { mode: "range", dateFormat: "d/m/Y", onClose: handleFilter });

    async function init() {
        showLoading(true);
        try {
            const response = await fetch(`${CSV_URL}&nocache=${Date.now()}`);
            const text = await response.text();
            db = parseCSV(text);
            handleFilter();
        } catch (err) {
            console.error("Fetch Error:", err);
        } finally {
            showLoading(false);
        }
    }

    function parseCSV(text) {
        const lines = text.split(/\r?\n/);
        return lines.slice(1).map(line => {
            const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (cols.length < 10) return null;
            
            // Clean purchase date for object creation
            const rawDate = (cols[3] || '').trim();
            const dateParts = rawDate.split('/');
            const dateObj = dateParts.length === 3 ? new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`) : null;

            return {
                dateStr: rawDate,
                dateObj: dateObj,
                orderId: (cols[4] || '').trim(),
                name: (cols[5] || '').trim(),
                platform: (cols[9] || '').trim(),
                state: (cols[12] || '').trim(),
                pName: (cols[15] || '').trim().replace(/"/g, ''),
                pCode: (cols[16] || '').trim(),
                searchBlob: cols.join(' ').toLowerCase()
            };
        }).filter(r => r && r.dateObj && !isNaN(r.dateObj.getTime()));
    }

    function handleFilter() {
        let filtered = [...db];
        
        // Search Filter
        const term = document.getElementById('search').value.toLowerCase();
        if (term) filtered = filtered.filter(r => r.searchBlob.includes(term));

        // Date Filter
        const dates = fp.selectedDates;
        if (dates.length === 2) {
            const start = dates[0].setHours(0,0,0,0);
            const end = dates[1].setHours(23,59,59,999);
            filtered = filtered.filter(r => r.dateObj >= start && r.dateObj <= end);
            document.getElementById('filter-indicator').innerText = `Filtered: ${fp.formatDate(dates[0], "d M")} - ${fp.formatDate(dates[1], "d M")}`;
        } else {
            document.getElementById('filter-indicator').innerText = "Showing All Records";
        }

        // Sort: Oldest First
        filtered.sort((a, b) => a.dateObj - b.dateObj);

        updateDashboard(filtered, dates);
    }

    function updateDashboard(data, range) {
        // Basic Counts
        document.getElementById('m-total').innerText = data.length.toLocaleString();
        document.getElementById('m-amazon').innerText = data.filter(r => r.platform.toLowerCase().includes('amazon')).length;
        document.getElementById('m-blinkit').innerText = data.filter(r => r.platform.toLowerCase().includes('blinkit')).length;
        document.getElementById('m-unique').innerText = new Set(data.map(r => r.name.toLowerCase())).size;
        document.getElementById('table-count').innerText = `Order Logs (${data.length})`;

        // Momentum Engine (FIXED)
        calculateMomentum(data, range);

        // Top Products
        const prodCounts = {};
        data.forEach(r => { if(r.pName) prodCounts[r.pName] = (prodCounts[r.pName] || 0) + 1 });
        const top5 = Object.entries(prodCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        document.getElementById('top-products').innerHTML = top5.map(p => `
            <div class="stats-row">
                <span class="stats-name" title="${p[0]}">${p[0]}</span>
                <span class="stats-val">${p[1]}</span>
            </div>
        `).join('');

        // Chart Trend
        renderChart(data);

        // Table Rendering
        document.getElementById('tableBody').innerHTML = data.map(r => `
            <tr>
                <td>${r.dateStr}</td>
                <td title="${r.pName}" style="font-weight:600;">${r.pName}</td>
                <td>${r.name}</td>
                <td style="color:var(--accent-blue); font-family:monospace;">${r.orderId}</td>
                <td><span class="badge badge-${r.platform.toLowerCase().includes('amazon') ? 'amazon' : 'blinkit'}">${r.platform}</span></td>
                <td>${r.state}</td>
                <td style="font-weight:700; color:var(--fedus-dark-orange);">${r.pCode || '--'}</td>
            </tr>
        `).join('');
    }

    function calculateMomentum(currentData, range) {
        let prevPeriodData = [];
        
        if (range.length === 2) {
            // Compare selected range vs the exact same length period prior
            const diff = range[1] - range[0];
            const pStart = new Date(range[0].getTime() - diff - 86400000);
            const pEnd = new Date(range[0].getTime() - 86400000);
            prevPeriodData = db.filter(r => r.dateObj >= pStart && r.dateObj <= pEnd);
        } else {
            // Default: Compare last 7 days of data vs previous 7 days
            const maxDate = new Date(Math.max(...db.map(r => r.dateObj)));
            const p1 = new Date(maxDate.getTime() - (7 * 86400000));
            const p2 = new Date(maxDate.getTime() - (14 * 86400000));
            prevPeriodData = db.filter(r => r.dateObj >= p2 && r.dateObj < p1);
            currentData = db.filter(r => r.dateObj >= p1);
        }

        const calc = (curr, prev) => {
            if (prev === 0) return curr > 0 ? 100 : 0;
            return (((curr - prev) / prev) * 100).toFixed(1);
        };

        const draw = (id, val) => {
            const el = document.getElementById(id);
            const isUp = val >= 0;
            el.className = `momentum ${isUp ? 'up' : 'down'}`;
            el.innerHTML = `<i class="fa fa-caret-${isUp ? 'up' : 'down'}"></i> ${isUp ? '+' : ''}${val}%`;
        };

        const curAmz = currentData.filter(r => r.platform.toLowerCase().includes('amazon')).length;
        const preAmz = prevPeriodData.filter(r => r.platform.toLowerCase().includes('amazon')).length;
        
        const curBli = currentData.filter(r => r.platform.toLowerCase().includes('blinkit')).length;
        const preBli = prevPeriodData.filter(r => r.platform.toLowerCase().includes('blinkit')).length;

        draw('m-momentum', calc(currentData.length, prevPeriodData.length));
        draw('m-amazon-growth', calc(curAmz, preAmz));
        draw('m-blinkit-growth', calc(curBli, preBli));
    }

    function renderChart(data) {
        const daily = {};
        data.forEach(r => {
            const k = r.dateStr;
            daily[k] = (daily[k] || 0) + 1;
        });

        const labels = Object.keys(daily);
        const values = Object.values(daily);

        if (trendChart) trendChart.destroy();
        
        const ctx = document.getElementById('trendChart').getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Orders per Day',
                    data: values,
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#f39c12'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function resetFilters() {
        document.getElementById('search').value = '';
        fp.clear();
        handleFilter();
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    window.onload = init;
</script>

</body>
</html>
